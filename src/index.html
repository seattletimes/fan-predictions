<%
  var predictionData = json.FanPredictions_Predictions;

  var groupedPredictions = {};

  var hawkScores = [];
  var patScores = [];
  var counts = [];
  var seahawkCount = 0;
  var patriotCount = 0;

  predictionData.forEach(function(p) { 
    hawkScores.push(p.seahawks * 1); 
    patScores.push(p.patriots * 1) 

    var finalScore = p.seahawks + "-" + p.patriots;
    if (!groupedPredictions[finalScore]) { 
      groupedPredictions[finalScore] = {
        seahawks: p.seahawks * 1,
        patriots: p.patriots * 1,
        count: 0
      }
    }
    groupedPredictions[finalScore].count += 1;
    counts.push(groupedPredictions[finalScore].count);
  });

  var maxHawkScore = Math.max.apply(null, hawkScores);
  var maxPatScore = Math.max.apply(null, patScores);
  var maxCount = Math.max.apply(null, counts);

  var maxScore = maxHawkScore > maxPatScore ? maxHawkScore : maxPatScore;
  
  for (var index in groupedPredictions) {
    var p = groupedPredictions[index];
    p.x = p.seahawks / maxScore * 100,
    p.y = p.patriots / maxScore * 100,
    p.opacity = p.count / maxCount;

    if (p.seahawks > p.patriots) {
      p.team = "seahawks";
      seahawkCount += p.count;
    } else {
      p.team = "patriots";
      patriotCount += p.count;
    }
  }

  var totalCount = seahawkCount + patriotCount;
  var seahawkPercent = Math.round(seahawkCount / totalCount * 100);
  var patriotPercent = Math.round(patriotCount / totalCount * 100);
%>

<!doctype html>
<html>
  <head>
    <title><%= json.project.title %></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <%= t.include("partials/_adHead.html") %>
  </head>

  <body>
    <nav class="top-bar">
      <%= t.include("partials/_adTop.html") %>
      <a class="logo" href="http://seattletimes.com">
        <img src="assets/logo-transparent.png" />
      </a>
    </nav>

    <div class="header">
      <a class="share"></a>
      <h1>Super bowl pick &rsquo;em<br><span class="green">Seahawks</span> <span class="blue">vs</span> <span class="red">Patriots</span></h1>
      <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
      tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam. Share your story on our <a href="http://projects.seattletimes.com/2014/hawks-fan-map" class="fancy-ref"><i class="fa fa-globe"></i> Hawks fan map.</a></p>
    </div>

    <div class="container">
      <div class="fan-predictions">

        <div class="form-container"><%= t.include("_form.html") %></div>

        <div class="results">
          <div class="scatter-box">
            <div class="y axis">Patriots</div>
            <div class="scatterplot">
              <% for (var index in groupedPredictions) { 
                var p = groupedPredictions[index]; %>
                <div class="point-container <%= p.team %>" style="left: <%= p.x %>%; bottom: <%= p.y %>%;">
                  <div class="point" style="opacity: <%= p.opacity %>;"></div>
                  <div class="tooltip">
                    <div class="score"><%= p.seahawks %> - <%= p.patriots %></div>
                    Count: <%= p.count %>
                  </div>
                </div>
              <% } %>
            </div>
            <div class="x axis">Seahawks</div>
          </div>

          <div class="sidebar">
            <p class="sidebar-title">WIN-O-METER</p>
            <div>
              <div class="sidebar-box">
                <div class="team-box seahawks">
                  <div class="team seahawks">Seahawks</div>
                  <div class="percent"><%= seahawkPercent %>%</div>
                </div>
                <div class="team-box patriots">
                  <div class="team patriots">Patriots</div>
                  <div class="percent"><%= patriotPercent %>%</div>
                </div>
                <div class="add-yourself">Add yourself!</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
<div class="clearing"></div>
      <%= t.include("_tiles.html") %>
    </div>
    <div class="clearing"></div>
<footer>
      <%= t.include("partials/_adFoot.html") %>
</footer>
    <script src="app.js"></script>
    <%= t.include("partials/_workHere.html") %>
  </body>
</html>
