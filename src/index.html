<%
  var predictionData = json.FanPredictions_Predictions;

  var groupedPredictions = {};

  var hawkScores = [];
  var patScores = [];
  var counts = [];
  var seahawkCount = 0;
  var patriotCount = 0;

  predictionData.forEach(function(p) { 
    hawkScores.push(p.seahawks * 1); 
    patScores.push(p.patriots * 1) 

    var finalScore = p.seahawks + "-" + p.patriots;
    if (!groupedPredictions[finalScore]) { 
      groupedPredictions[finalScore] = {
        seahawks: p.seahawks * 1,
        patriots: p.patriots * 1,
        count: 0
      }
    }
    groupedPredictions[finalScore].count += 1;
    counts.push(groupedPredictions[finalScore].count);
  });

  var maxHawkScore = Math.max.apply(null, hawkScores);
  var maxPatScore = Math.max.apply(null, patScores);
  var maxCount = Math.max.apply(null, counts);

  var maxScore = maxHawkScore > maxPatScore ? maxHawkScore : maxPatScore;
  
  for (var index in groupedPredictions) {
    var p = groupedPredictions[index];
    p.x = p.seahawks / maxScore * 100,
    p.y = p.patriots / maxScore * 100,
    p.opacity = p.count / maxCount;

    if (p.seahawks > p.patriots) {
      p.team = "seahawks";
      seahawkCount += p.count;
    } else {
      p.team = "patriots";
      patriotCount += p.count;
    }
  }

  var totalCount = seahawkCount + patriotCount;
  var seahawkPercent = Math.round(seahawkCount / totalCount * 100);
  var patriotPercent = Math.round(patriotCount / totalCount * 100);
%>

<!doctype html>
<html>
  <head>
    <title><%= json.project.title %></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <%= t.include("partials/_adHead.html") %>
  </head>

  <body>

    <nav class="top-bar">
      <a class="logo" href="http://seattletimes.com">
        <img src="http://seattletimes.com/art/ui/seattletimeslogo_home.svg">
      </a>
    </nav>

    <%= t.include("_form.html") %>

    <h1>Who's Going to Win the Super Bowl?</h1>

    <div class="container">
      <div class="scatterplot">
        <% for (var index in groupedPredictions) { 
          var p = groupedPredictions[index]; %>
          <div class="point-container <%= p.team %>">
            <div class="point" style="left: <%= p.x %>%; bottom: <%= p.y %>%; opacity: <%= p.opacity %>;"></div>
            <div class="tooltip" style="left: <%= p.x + 3 %>%; bottom: <%= p.y - 8 %>%;">
              <div class="score"><%= p.seahawks %> - <%= p.patriots %></div>
              Count: <%= p.count %>
            </div>
          </div>
        <% } %>
      </div>

      <div class="sidebar">
        <div>
          Seahawks: <%= seahawkPercent %>%
          <br>
          Patriots: <%= patriotPercent %>%
        </div>
        
        <div class="add-yourself">Add yourself</div>
        <div class="thanks">Thanks for your submission.</div>
      </div>
    </div>

    <script src="app.js"></script>
    <% /*= t.include("partials/_adFoot.html"); */ %>
    <%= t.include("partials/_workHere.html") %>
  </body>
</html>
